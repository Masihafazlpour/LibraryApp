<!doctype html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ â€” Ø³Ù…Ú©</title>
  <style>
    :root {
      --bg: linear-gradient(180deg, #071124 0%, #071a2a 60%);
      --panel-bg: #0b1220;
      --card-bg: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      --accent: #2b9df4;
      --accent-2: #1b7ed6;
      --muted: #9aa7b2;
      --text: #e6eef6;
      --danger: #e85a5a;
      --success: #3cb371;
      --glass: rgba(255, 255, 255, 0.02);
      --radius: 12px;
      --card-border: rgba(255, 255, 255, 0.03);
      --print-bg: #ffffff;
      color-scheme: dark;
      font-family: "Tahoma", "Vazir", "Segoe UI", sans-serif;
    }

    :root.light {
      --bg: linear-gradient(180deg, #f5f8fb 0%, #eef4fb 60%);
      --panel-bg: #ffffff;
      --card-bg: rgba(2, 6, 23, 0.02);
      --accent: #1f78d1;
      --accent-2: #0f5bb3;
      --muted: #516374;
      --text: #17222a;
      --card-border: rgba(0, 0, 0, 0.06);
      --print-bg: #ffffff;
      color-scheme: light;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased
    }

    .app {
      max-width: 1200px;
      margin: 18px auto;
      padding: 18px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.02);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.45);
      min-height: 75vh
    }

    header {
      display: flex;
      align-items: center;
      gap: 14px
    }

    .logo {
      width: 62px;
      height: 62px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #fff;
      font-size: 20px;
      overflow: hidden
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px
    }

    h1 {
      margin: 0;
      font-size: 20px
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px
    }

    nav {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap
    }

    nav button {
      background: transparent;
      border: 0;
      padding: 8px 12px;
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      transition: all .12s
    }

    nav button.active {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--card-border);
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.25)
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      margin-top: 14px;
      align-items: start
    }

    @media(max-width:980px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: var(--panel-bg);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(2, 6, 23, 0.35)
    }

    .small {
      font-size: 13px;
      color: var(--muted)
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 0;
      cursor: pointer
    }

    .btn.primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #fff
    }

    .btn.warn {
      background: var(--success);
      color: #fff
    }

    .btn.danger {
      background: var(--danger);
      color: #fff
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--card-border);
      color: var(--muted)
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      background: transparent;
      color: inherit;
      outline: none
    }

    select.fancy {
      background: var(--card-bg);
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      color: inherit
    }

    .photo-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--card-border)
    }

    .leftColumnActions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px
    }

    #panel,
    #main {
      max-height: calc(100vh - 260px);
      overflow: auto;
      padding: 12px;
      box-sizing: border-box
    }

    .list-scroll {
      max-height: 480px;
      overflow: auto
    }

    /* table spacing improvements */
    .list-scroll table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 12px
    }

    .list-scroll thead th {
      padding: 10px 12px;
      text-align: center;
      color: var(--muted);
      font-weight: 700;
      background: transparent
    }

    .list-scroll tbody td {
      padding: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      vertical-align: middle;
      text-align: center
    }

    .list-scroll tbody tr {
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.25);
      border-radius: 10px
    }

    .form-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px
    }

    .form-row label {
      min-width: 110px;
      text-align: right;
      font-size: 13px;
      color: var(--muted)
    }

    .form-row .field {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center
    }

    @media(max-width:900px) {
      .form-row {
        flex-direction: column;
        align-items: stretch
      }

      .form-row label {
        min-width: unset;
        text-align: right;
        margin-bottom: 6px
      }
    }

    /* print area default hidden */
    #printArea {
      display: none;
    }

    /* ====== REPLACED: Safer @media print (fixes one-page print issue) ====== */
    @media print {

      /* hide everything by default */
      body * {
        visibility: hidden !important;
      }

      /* show only the print area and its children */
      #printArea,
      #printArea * {
        visibility: visible !important;
      }

      /* allow browser to paginate: do not use position: fixed */
      #printArea {
        position: static !important;
        display: block !important;
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      .no-print {
        display: none !important;
      }

      /* each .print-page becomes an actual printed page */
      .print-page {
        box-sizing: border-box;
        width: 210mm;
        height: auto;
        padding: 10mm;
        background: var(--print-bg);
        -webkit-print-color-adjust: exact;
        page-break-after: always;
        break-after: page;
      }

      /* avoid an extra blank page */
      .print-page:last-child {
        page-break-after: auto !important;
        break-after: auto !important;
      }

      /* avoid splitting cards/tables between pages */
      .print-card,
      .group-page,
      table.report-table tr,
      .print-card * {
        page-break-inside: avoid !important;
        break-inside: avoid-column !important;
      }

      /* remove shadows/rounded corners in print */
      .print-page,
      .print-page * {
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      /* ensure long text splits nicely */
      p,
      div {
        orphans: 3;
        widows: 3;
      }
    }

    /* print card */
    .print-card {
      box-sizing: border-box;
      width: 10cm;
      height: 6cm;
      padding: 10px;
      border-radius: 8px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      page-break-inside: avoid;
      -webkit-print-color-adjust: exact
    }

    .double-border {
      position: relative;
      border: 2px solid rgba(0, 0, 0, 0.25)
    }

    .double-border::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 6px;
      border: 2px solid rgba(255, 255, 255, 0.06);
      z-index: -1
    }

    .print-card .lib {
      font-weight: 800;
      text-align: center;
      font-size: 15px
    }

    .print-card .flex-box {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px
    }

    .print-card .left {
      width: 100%;
      direction: rtl;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px
    }

    .print-card .code {
      font-weight: 700
    }

    .print-card .name {
      font-size: 14px
    }

    .print-card .phone {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.95)
    }

    .print-card .photo {
      width: 90px;
      height: 90px;
      border-radius: 8px;
      object-fit: cover;
      background: #fff;
      border: 2px solid rgba(255, 255, 255, 0.12)
    }

    /* group printing */
    .group-page {
      width: 210mm;
      height: 297mm;
      box-sizing: border-box;
      padding: 10mm;
      display: flex;
      flex-wrap: wrap;
      background: var(--print-bg);
    }

    .group-page .card-wrapper {
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    /* toast & helpers */
    .toast-wrap {
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .toast {
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      opacity: 0;
      transform: translateY(6px);
      transition: all .2s
    }

    .toast.show {
      opacity: 1;
      transform: none
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    .op {
      padding: 6px 8px;
      border-radius: 8px;
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer
    }

    .op:hover {
      transform: translateY(-2px)
    }

    /* LOGIN MODAL */
    #loginModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.75), rgba(2, 6, 23, 0.85));
      z-index: 999999
    }

    #loginModal .modalCard {
      width: 380px;
      max-width: 95%;
      background: var(--panel-bg);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      text-align: center
    }

    #loginModal h2 {
      margin: 0 0 8px 0
    }

    #loginModal p {
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 13px
    }

    #loginModal input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      margin-bottom: 10px
    }

    #loginModal .actions {
      display: flex;
      gap: 8px;
      justify-content: center
    }

    #loginModal .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px
    }

    #loginModal.hidden {
      display: none
    }

    /* strongly hide app until login if required */
    .app.hidden {
      visibility: hidden
    }

    /* commitment symbol styling */
    .commit-yes {
      color: var(--success);
      font-weight: 700;
    }

    .commit-no {
      color: var(--danger);
      font-weight: 700;
    }

    /* improve report contrast */
    .list-scroll thead th {
      color: var(--text);
      background: rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body>
  <!-- main app (hidden until successful login if required) -->
  <div class="app no-print" role="application" id="appRoot">
    <header>
      <div class="logo" id="logoEl">ğŸ“š</div>
      <div>
        <h1 id="libName">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù†</h1>
        <div class="subtitle" id="subtitle">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§ØŒ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ùˆ Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</div>
      </div>

      <div class="top-right" style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <button id="themeToggle" class="btn ghost" title="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ™</button>
        <div>
          <div id="nowShamsi">---</div>
          <div class="small" id="version">Ù†Ø³Ø®Ù‡ ÙˆØ¨</div>
        </div>
      </div>
    </header>

    <nav id="tabs">
      <button class="active" data-tab="dashboard">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
      <button data-tab="members">ğŸ‘¥ Ø§Ø¹Ø¶Ø§</button>
      <button data-tab="books">ğŸ“š Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
      <button data-tab="loans">ğŸ”„ Ø§Ù…Ø§Ù†Ø§Øª</button>
      <button data-tab="reports">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</button>
      <button data-tab="cards">ğŸ´ Ú†Ø§Ù¾ Ú©Ø§Ø±Øª</button>
      <button data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </nav>

    <div class="grid" style="margin-top:12px">
      <!-- LEFT -->
      <div>
        <div id="panel" class="card">
          <div id="panelContent">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>

        <div class="card leftColumnActions" style="margin-top:12px">
          <!-- <div class="small">Ø¯Ø³ØªÙˆØ±Ø§Øª Ø³Ø±ÛŒØ¹</div> -->
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <!-- <button id="quick_add_member" class="btn primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</button>
            <button id="quick_add_book" class="btn">+ Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨</button>
            <button id="quick_new_loan" class="btn warn">+ Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button> -->
            <div style="height:6px"></div>
            <button id="backupBtn" class="btn">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)</button>
            <button id="restoreBtn" class="btn">â†©ï¸ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
            <input id="fileRestore" type="file" accept=".json,application/json" style="display:none" />
            <button id="exportJSON" class="btn ghost">â¬‡ï¸ Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON</button>
            <!-- <button id="printReportQuick" class="btn">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</button> -->

            <!-- Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Factory reset) -->
            <button id="factoryResetBtn" class="btn danger">ğŸ” Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div id="main" class="card h-lg">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</div>
      </div>
    </div>
  </div>

  <!-- print area -->
  <div id="printArea" aria-hidden="true"></div>

  <!-- toast -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modalCard" role="document">
      <h2>ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
      <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ù…Ø¯ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
      <input id="adminPassInput" type="password" placeholder="Ø±Ù…Ø² Ù…Ø¯ÛŒØ±" autocomplete="current-password" />
      <div class="actions">
        <button id="loginSubmit" class="btn primary">ÙˆØ±ÙˆØ¯</button>
        <button id="loginCancel" class="btn ghost">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
      </div>
      <div class="note">Ø±Ù…Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶: <strong>111</strong></div>
      <div id="loginErr" style="color:var(--danger);margin-top:8px;display:none"></div>
    </div>
  </div>

  <script>
    (async function () {
      'use strict';

      /* ================ IndexedDB wrapper ================ */
      const DB_NAME = "school_library_db_v1";
      const DB_VERSION = 1;
      let db = null;
      function openDB() {
        return new Promise((res, rej) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = (e) => {
            const idb = e.target.result;
            if (!idb.objectStoreNames.contains('settings')) idb.createObjectStore('settings', { keyPath: 'key' });
            if (!idb.objectStoreNames.contains('members')) {
              const m = idb.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
              m.createIndex('membershipCode', 'membershipCode', { unique: true });
            }
            if (!idb.objectStoreNames.contains('books')) {
              const b = idb.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
              b.createIndex('regNumber', 'regNumber', { unique: true });
            }
            if (!idb.objectStoreNames.contains('loans')) {
              const l = idb.createObjectStore('loans', { keyPath: 'id', autoIncrement: true });
              l.createIndex('memberId', 'memberId', { unique: false });
              l.createIndex('bookId', 'bookId', { unique: false });
            }
          };
          req.onsuccess = (e) => { db = e.target.result; res(db); };
          req.onerror = (e) => rej(e);
        });
      }
      function idbGet(store, key) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readonly'); const st = tx.objectStore(store); const r = st.get(key); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
      function idbPut(store, obj) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readwrite'); const st = tx.objectStore(store); const r = st.put(obj); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
      function idbAdd(store, obj) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readwrite'); const st = tx.objectStore(store); const r = st.add(obj); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
      function idbAll(store) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readonly'); const st = tx.objectStore(store); const r = st.getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
      function idbDelete(store, key) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readwrite'); const st = tx.objectStore(store); const r = st.delete(key); r.onsuccess = () => res(true); r.onerror = () => rej(r.error); }); }
      function idbClear(store) { return new Promise((res, rej) => { const tx = db.transaction(store, 'readwrite'); const st = tx.objectStore(store); const r = st.clear(); r.onsuccess = () => res(true); r.onerror = () => rej(r.error); }); }

      /* ================ Utilities ================ */
      function toJalali(gy, gm, gd) {
        function isLeap(y) { return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0); }
        let g_d_m = [0, 31, (isLeap(gy) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        let gy2 = gy - 1600, gm2 = gm - 1, gd2 = gd - 1;
        let g_day_no = 365 * gy2 + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400);
        for (let i = 0; i < gm2; ++i) g_day_no += g_d_m[i + 1];
        g_day_no += gd2;
        let j_day_no = g_day_no - 79;
        let j_np = Math.floor(j_day_no / 12053);
        j_day_no = j_day_no % 12053;
        let jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
        j_day_no %= 1461;
        if (j_day_no >= 366) { jy += Math.floor((j_day_no - 366) / 365); j_day_no = (j_day_no - 366) % 365; }
        let jm = 0;
        for (let i = 1; i <= 12; i++) {
          let v = i <= 6 ? 31 : (i <= 11 ? 30 : 29);
          if (j_day_no < v) { jm = i; break; }
          j_day_no -= v;
        }
        let jd = j_day_no + 1;
        return [jy, jm, jd];
      }
      function nowShamsiFull() {
        const d = new Date();
        const [jy, jm, jd] = toJalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
        return `${jy}/${String(jm).padStart(2, '0')}/${String(jd).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
      }
      function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
      function downloadFile(content, filename, mime = 'application/json') { const a = document.createElement('a'); const blob = new Blob([content], { type: mime }); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }
      function downloadCSV(lines, filename = 'export.csv') { const bom = '\uFEFF'; downloadFile(bom + lines.join('\n'), filename, 'text/csv;charset=utf-8;'); }
      async function resizeImageFile(file, maxW = 800, maxH = 800, quality = 0.8) {
        const dataUrl = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
        return await new Promise((res, rej) => {
          const img = new Image(); img.onload = () => {
            let w = img.width, h = img.height;
            const ratio = Math.min(maxW / w, maxH / h, 1);
            w = Math.round(w * ratio); h = Math.round(h * ratio);
            const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h);
            ctx.drawImage(img, 0, 0, w, h);
            const out = canvas.toDataURL('image/jpeg', quality); res(out);
          }; img.onerror = rej; img.src = dataUrl;
        });
      }

      /* ================ Settings + CRUD ================ */
      async function ensureDefaults() {
        if (!await idbGet('settings', 'LibraryName')) await idbPut('settings', { key: 'LibraryName', value: 'Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø´Ù‡ÛŒØ¯ Ø´ÛŒØ± Ø¢Ù‚Ø§Ø¦ÛŒ' });
        if (!await idbGet('settings', 'LoanDaysDefault')) await idbPut('settings', { key: 'LoanDaysDefault', value: '10' });
        if (!await idbGet('settings', 'MaxBooksPerMember')) await idbPut('settings', { key: 'MaxBooksPerMember', value: '3' });
        if (!await idbGet('settings', 'NextMemberCode')) await idbPut('settings', { key: 'NextMemberCode', value: '1000' });
        if (!await idbGet('settings', 'NextBookReg')) await idbPut('settings', { key: 'NextBookReg', value: '1000' });
        if (!await idbGet('settings', 'Grades')) await idbPut('settings', { key: 'Grades', value: 'Ø¯Ù‡Ù…,ÛŒØ§Ø²Ø¯Ù‡Ù…,Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…,Ù¾Ø§ÛŒÙ‡,ÛŒØ§Ø²Ø¯Ù‡Ù… - Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…,Ø¬Ø§Ù…Ø¹' });
        if (!await idbGet('settings', 'Fields')) await idbPut('settings', { key: 'Fields', value: 'ØªØ¬Ø±Ø¨ÛŒ,Ø±ÛŒØ§Ø¶ÛŒ,Ø§Ù†Ø³Ø§Ù†ÛŒ,Ø¬Ø§Ù…Ø¹' });
        // default admin password = "111" -> sha256('111')
        if (!await idbGet('settings', 'AdminPasswordHash')) await idbPut('settings', { key: 'AdminPasswordHash', value: 'f6e0a1e2ac41945a9aa7ff8a8aaa0cebc12a3bcc981a929ad5cf810a090e11ae' });
        // require login default true
        if (!await idbGet('settings', 'RequireAdminLogin')) await idbPut('settings', { key: 'RequireAdminLogin', value: '1' });
        if (!await idbGet('settings', 'Theme')) await idbPut('settings', { key: 'Theme', value: 'dark' });
      }
      async function getSetting(key) { const v = await idbGet('settings', key); return v ? v.value : ''; }
      async function setSetting(key, value) { await idbPut('settings', { key, value }); }

      async function findMemberByCode(code) { const all = await getMembers(); return all.find(m => String(m.membershipCode || '') === String(code)); }
      async function findBookByReg(reg) { const all = await getBooks(); return all.find(b => String(b.regNumber || '') === String(reg)); }

      async function addMember(obj) {
        if (!obj || !obj.membershipCode) return { ok: false, error: 'invalid' };
        const existing = await findMemberByCode(obj.membershipCode);
        if (existing) return { ok: false, error: 'duplicate' };
        try { await idbAdd('members', obj); return { ok: true }; } catch (err) { return { ok: false, error: err }; }
      }
      async function updateMember(obj) {
        const all = await getMembers();
        const dup = all.find(m => m.membershipCode === obj.membershipCode && m.id !== obj.id);
        if (dup) throw new Error('duplicate membershipCode');
        await idbPut('members', obj);
      }
      async function getMembers() { return await idbAll('members'); }
      async function deleteMember(id) { return await idbDelete('members', id); }

      async function addBook(obj) {
        if (!obj || !obj.regNumber) return { ok: false, error: 'invalid' };
        const existing = await findBookByReg(obj.regNumber);
        if (existing) return { ok: false, error: 'duplicate' };
        try { await idbAdd('books', obj); return { ok: true }; } catch (err) { return { ok: false, error: err }; }
      }
      async function updateBook(obj) {
        const all = await getBooks();
        const dup = all.find(b => b.regNumber === obj.regNumber && b.id !== obj.id);
        if (dup) throw new Error('duplicate regNumber');
        const books = await getBooks();
        const existing = books.find(b => b.id === obj.id);
        if (existing) {
          const oldTotal = Number(existing.total || 0);
          const newTotal = Number(obj.total || 1);
          const oldAvailable = Number(existing.available || 0);
          const delta = newTotal - oldTotal;
          let newAvailable = oldAvailable + delta;
          if (newAvailable > newTotal) newAvailable = newTotal;
          if (newAvailable < 0) newAvailable = 0;
          obj.available = newAvailable;
        }
        await idbPut('books', obj);
      }
      async function getBooks() { return await idbAll('books'); }
      async function deleteBook(id) { return await idbDelete('books', id); }

      async function addLoan(obj) {
        await idbAdd('loans', obj);
        const books = await getBooks(); const b = books.find(x => x.id === obj.bookId);
        if (b) { b.available = Math.max(0, (b.available || 0) - 1); await updateBook(b).catch(() => { }); }
      }
      async function returnLoan(id) {
        const loans = await idbAll('loans'); const l = loans.find(x => x.id === id); if (!l) return;
        if (!l.isReturned) {
          l.isReturned = true; l.returnDate = (new Date()).toISOString(); await idbPut('loans', l);
          const books = await getBooks(); const b = books.find(x => x.id === l.bookId); if (b) { b.available = (b.available || 0) + 1; if (b.available > b.total) b.available = b.total; await updateBook(b).catch(() => { }); }
        }
      }
      async function deleteLoan(id) {
        const loans = await idbAll('loans'); const l = loans.find(x => x.id === id); if (!l) return;
        if (!l.isReturned) {
          const books = await getBooks(); const b = books.find(x => x.id === l.bookId); if (b) { b.available = (b.available || 0) + 1; if (b.available > b.total) b.available = b.total; await updateBook(b).catch(() => { }); }
        }
        await idbDelete('loans', id);
      }
      async function getLoans() { return await idbAll('loans'); }

      /* CSV & helpers */
      function csvSplitLine(line) {
        const out = []; let cur = ''; let inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i + 1] === '"') { cur += '"'; i++; continue; }
            inQ = !inQ; continue;
          }
          if (ch === ',' && !inQ) { out.push(cur); cur = ''; continue; }
          cur += ch;
        }
        out.push(cur);
        return out.map(s => s.replace(/^\uFEFF/, '').trim());
      }
      function debounce(fn, wait = 250) { let t = null; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }

      // robust normalization for taahod/commitment values
      function normalizeTaahodValue(v) {
        if (v === null || v === undefined) return false;
        let s = String(v).trim().toLowerCase();
        s = s.replace(/^\uFEFF/, '').replace(/"/g, '').trim();
        // normalize common Persian/English tokens
        const yes = ['Ø¯Ø§Ø±Ø¯', 'Ø¯Ø§Ø±Ù…', 'yes', 'true', '1', 'âœ“', 'âœ”', 'have', 'ok', 'y', 'Ø¯Ø§Ø±'];
        const no = ['Ù†Ø¯Ø§Ø±Ø¯', 'Ù†Ø¯Ø§Ø±Ù…', 'no', 'false', '0', 'Ã—', 'x', 'n', 'Ù†Ø¯Ø§Ø±'];
        // try direct match
        if (yes.includes(s)) return true;
        if (no.includes(s)) return false;
        // try contains (for Persian like 'Ø¯Ø§Ø±Ø¯' inside)
        for (const t of yes) if (s.indexOf(t) !== -1) return true;
        for (const t of no) if (s.indexOf(t) !== -1) return false;
        // numeric
        if (!isNaN(Number(s))) return Number(s) !== 0;
        // fallback: if contains Persian 'Ø¯' and not 'Ù†' -> likely 'Ø¯Ø§Ø±Ø¯'
        if (s.indexOf('Ø¯') !== -1 && s.indexOf('Ù†') === -1) return true;
        return false;
      }

      // normalize header (strip spaces, punctuation, BOM, lowercase)
      function normalizeHeaderName(h) {
        if (!h && h !== 0) return '';
        let s = String(h).replace(/^\uFEFF/, '').toLowerCase();
        s = s.replace(/[ _\-\u00A0]+/g, ''); // remove spaces, underscores, hyphens, nbsp
        s = s.replace(/[(){}[\]]+/g, '');
        s = s.replace(/["']/g, '');
        return s.trim();
      }

      // map a header token to canonical member field
      function headerToMemberKey(h) {
        const s = normalizeHeaderName(h);
        if (!s) return null;
        // membership code variants
        if (s.includes('membershipcode') || s.includes('membership_code') || s.includes('Ú©Ø¯Ø¹Ø¶ÙˆÛŒØª') || s.includes('Ú©Ø¯Ù…Ù…Ø¨Ø±') || s.includes('Ú©Ø¯Ù…Ù…Ø¨Ø±Ø´ÛŒÙ¾') || s.includes('Ú©Ø¯')) {
          // careful: 'Ú©Ø¯' alone ambiguous; prioritize explicit tokens first
          if (s.includes('Ú©Ø¯Ù…Ù„ÛŒ') || s.includes('nationalcode') || s.includes('Ú©Ø¯Ù…Ø¯')) {
            // handled below as national code
          } else if (s.includes('Ú©Ø¯Ù…Ù„ÛŒ')) {
            // handled later
          } else if (s.includes('Ú©Ø¯Ø¹Ø¶ÙˆÛŒØª') || s.includes('membershipcode') || s.includes('membership')) {
            return 'membershipCode';
          } else if (s === 'Ú©Ø¯') {
            // ambiguous; prefer membershipCode if other tokens present? return null to leave to positional fallback
          }
        }
        // first name
        if (s === 'Ù†Ø§Ù…' || s === 'firstname' || s.includes('firstname') || s.includes('fname') || s.includes('name')) return 'firstName';
        // last name
        if (s.includes('Ù†Ø§Ù…Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ') || s.includes('lastname') || s.includes('family')) return 'lastName';
        // phone / ØªÙ„ÙÙ† / Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
        if (s.includes('Ø´Ù…Ø§Ø±ØªÙ„ÙÙ†') || s.includes('Ø´Ù…Ø§Ø±ØªÙ…Ø§Ø³') || s.includes('ØªÙ„ÙÙ†') || s.includes('Ø´Ù…Ø§Ø±Ù‡')) return 'phone';
        // national code
        if (s.includes('Ú©Ø¯Ù…Ù„ÛŒ') || s.includes('nationalcode') || s.includes('national')) return 'nationalCode';
        // commitment / ØªØ¹Ù‡Ø¯ Ù†Ø§Ù…Ù‡ / ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡ / taahod
        if (s.includes('ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡') || s.includes('ØªØ¹Ù‡Ø¯') || s.includes('taahod') || s.includes('commit')) return 'commitment';
        // field / Ø±Ø´ØªÙ‡
        if (s.includes('Ø±Ø´ØªÙ‡') || s.includes('field')) return 'field';
        // grade / Ù¾Ø§ÛŒÙ‡
        if (s.includes('Ù¾Ø§ÛŒÙ‡') || s.includes('grade')) return 'grade';
        // membership code generic matches (try english)
        if (s.includes('membership') || s.includes('membercode') || s.includes('memberid')) return 'membershipCode';
        // reg fallback
        return null;
      }

      /* UI refs */
      const tabs = document.querySelectorAll('#tabs button');
      const panelContent = document.getElementById('panelContent');
      const main = document.getElementById('main');
      const libNameEl = document.getElementById('libName');
      const nowShamsiEl = document.getElementById('nowShamsi');
      const themeToggleBtn = document.getElementById('themeToggle');
      const printArea = document.getElementById('printArea');
      const logoEl = document.getElementById('logoEl');
      const appRoot = document.getElementById('appRoot');

      const quickAddMemberBtn = document.getElementById('quick_add_member');
      const quickAddBookBtn = document.getElementById('quick_add_book');
      const quickNewLoanBtn = document.getElementById('quick_new_loan');

      const factoryResetBtn = document.getElementById('factoryResetBtn');

      let currentEditingMemberId = null;
      let currentEditingBookId = null;

      tabs.forEach(b => b.addEventListener('click', (e) => { tabs.forEach(x => x.classList.remove('active')); b.classList.add('active'); showTab(b.dataset.tab); }));

      function showTab(tab) { panelContent.innerHTML = ''; main.innerHTML = ''; if (tab === 'dashboard') renderDashboard(); if (tab === 'members') renderMembers(); if (tab === 'books') renderBooks(); if (tab === 'loans') renderLoans(); if (tab === 'reports') renderReports(); if (tab === 'cards') renderCardTools(); if (tab === 'settings') renderSettings(); }

      /* ================ Login modal logic ================ */
      const loginModal = document.getElementById('loginModal');
      const loginInput = document.getElementById('adminPassInput');
      const loginSubmit = document.getElementById('loginSubmit');
      const loginCancel = document.getElementById('loginCancel');
      const loginErr = document.getElementById('loginErr');

      async function showLoginModal() {
        loginErr.style.display = 'none';
        loginErr.textContent = '';
        loginInput.value = '';
        loginModal.classList.remove('hidden');
        loginModal.setAttribute('aria-hidden', 'false');
        // hide app behind modal strongly
        appRoot.classList.add('hidden');
        setTimeout(() => loginInput.focus(), 30);
      }
      function hideLoginModal() {
        loginModal.classList.add('hidden');
        loginModal.setAttribute('aria-hidden', 'true');
        appRoot.classList.remove('hidden');
      }

      loginCancel.addEventListener('click', () => {
        try { window.close(); } catch (e) { appRoot.style.display = 'none'; hideLoginModal(); }
      });

      loginSubmit.addEventListener('click', async () => {
        const pass = loginInput.value || '';
        if (!pass) { loginErr.style.display = 'block'; loginErr.textContent = 'Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'; return; }
        const hash = await sha256(pass);
        const stored = await getSetting('AdminPasswordHash');
        if (hash === (stored || '')) {
          hideLoginModal();
          await continueBootAfterLogin();
          showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚');
        } else {
          loginErr.style.display = 'block';
          loginErr.textContent = 'Ø±Ù…Ø² Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª';
          loginInput.focus();
        }
      });

      loginInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') loginSubmit.click();
      });

      /* Continue boot after successful login */
      async function continueBootAfterLogin() {
        const lib = await getSetting('LibraryName'); libNameEl.textContent = lib || 'Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø´Ù‡ÛŒØ¯ Ø´ÛŒØ± Ø¢Ù‚Ø§Ø¦ÛŒ';
        const logoData = await getSetting('LogoDataURL'); if (logoData) logoEl.innerHTML = `<img src="${logoData}" alt="logo">`;
        nowShamsiEl.textContent = nowShamsiFull(); setInterval(() => nowShamsiEl.textContent = nowShamsiFull(), 1000);
        const theme = await getSetting('Theme') || 'dark'; await applyTheme(theme);
        showTab('dashboard');
      }

      /* applyTheme */
      async function applyTheme(theme) {
        if (theme === 'light') { document.documentElement.classList.add('light'); themeToggleBtn.textContent = 'â˜€ï¸'; themeToggleBtn.title = 'Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù† (Ø±ÙˆØ´Ù† Ø§Ø³Øª) â€” Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒÚ©'; document.documentElement.style.setProperty('--active-tab-color', '#000'); }
        else { document.documentElement.classList.remove('light'); themeToggleBtn.textContent = 'ğŸŒ™'; themeToggleBtn.title = 'Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© (ØªØ§Ø±ÛŒÚ© Ø§Ø³Øª) â€” Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù†'; document.documentElement.style.setProperty('--active-tab-color', '#fff'); }
        await setSetting('Theme', theme);
      }
      themeToggleBtn.addEventListener('click', async () => { const cur = (await getSetting('Theme')) || 'dark'; const next = cur === 'light' ? 'dark' : 'light'; await applyTheme(next); showToast('ØªÙ… ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ' + (next === 'light' ? 'Ø±ÙˆØ´Ù†' : 'ØªØ§Ø±ÛŒÚ©')); });

      /* toast */
      const toastWrap = document.getElementById('toastWrap');
      function showToast(text, timeout = 2200) {
        const el = document.createElement('div'); el.className = 'toast'; el.textContent = text; toastWrap.appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => { try { toastWrap.removeChild(el) } catch (e) { } }, 200); }, timeout);
      }

      /* ================ BOOT sequence ================ */
      async function boot() {
        await openDB(); await ensureDefaults();
        const requireLogin = (await getSetting('RequireAdminLogin')) === '1';
        if (requireLogin) {
          await showLoginModal();
        } else {
          appRoot.classList.remove('hidden');
          await continueBootAfterLogin();
        }
      }
      await boot();

      /* ------------------ Dashboard ========== */
      async function renderDashboard() {
        const m = await getMembers(), b = await getBooks(), l = await getLoans();
        panelContent.innerHTML = `<div class="small">Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹</div>
        <div class="flow" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <div style="min-width:160px;padding:12px;border-radius:10px;background:var(--card-bg)"><div class="small">Ø§Ø¹Ø¶Ø§</div><div style="font-size:20px">${m.length}</div></div>
          <div style="min-width:160px;padding:12px;border-radius:10px;background:var(--card-bg)"><div class="small">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</div><div style="font-size:20px">${b.length}</div></div>
          <div style="min-width:160px;padding:12px;border-radius:10px;background:var(--card-bg)"><div class="small">Ø§Ù…Ø§Ù†Ø§Øª Ø¬Ø§Ø±ÛŒ</div><div style="font-size:20px">${l.filter(x => !x.isReturned).length}</div></div>
        </div>`;
        main.innerHTML = `<div class="small">Ø¢Ø®Ø±ÛŒÙ† Ø§Ø¹Ø¶Ø§</div><div style="margin-top:8px">${(m.slice(0, 10)).map(mm => `<div style="padding:10px;border-radius:10px;margin-bottom:8px;background:var(--card-bg)">${escapeHtml(mm.membershipCode)} â€” ${escapeHtml(mm.firstName)} ${escapeHtml(mm.lastName)}</div>`).join('')}</div>`;
      }

      /* ========== Members ========== */
      async function renderMembers() {
        currentEditingMemberId = null;
        panelContent.innerHTML = `
        <div class="small">ÙØ±Ù… Ø«Ø¨Øª Ø¹Ø¶Ùˆ</div>
        <div style="margin-top:8px">
          <div class="form-row"><label>Ú©Ø¯ Ø¹Ø¶ÙˆÛŒØª</label><div class="field"><input id="m_code" type="text" /></div></div>
          <div class="form-row"><label>Ù†Ø§Ù…</label><div class="field"><input id="m_first" type="text" /></div></div>
          <div class="form-row"><label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label><div class="field"><input id="m_last" type="text" /></div></div>
          <div class="form-row"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label><div class="field"><input id="m_phone" type="text" /></div></div>
          <div class="form-row"><label>Ú©Ø¯Ù…Ù„ÛŒ</label><div class="field"><input id="m_national" type="text" /></div></div>
          <div class="form-row"><label>Ù¾Ø§ÛŒÙ‡</label><div class="field"><select id="m_grade" class="fancy"></select></div></div>
          <div class="form-row"><label>Ø±Ø´ØªÙ‡</label><div class="field"><select id="m_field" class="fancy"></select></div></div>

          <div class="form-row"><label>ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡</label>
            <div class="field">
              <label style="display:inline-flex;align-items:center;gap:6px"><input type="radio" name="m_commit" value="1" checked /> Ø¯Ø§Ø±Ø¯</label>
              <label style="display:inline-flex;align-items:center;gap:6px;margin-left:10px"><input type="radio" name="m_commit" value="0" /> Ù†Ø¯Ø§Ø±Ø¯</label>
            </div>
          </div>

          <div class="form-row small-input"><label>Ø¹Ú©Ø³</label><div class="field"><input id="m_photo" type="file" accept="image/*" /></div></div>
          <div class="form-row"><label></label><div class="field"><img id="m_preview" class="photo-preview" src="" alt="" /></div></div>
          <div class="form-row"><label></label><div class="controls">
            <button id="m_add" class="btn primary">Ø«Ø¨Øª Ø¹Ø¶Ùˆ</button>
            <button id="m_print_current" class="btn">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ú©Ø§Ø±Øª Ø¬Ø§Ø±ÛŒ</button>
            <button id="m_import" class="btn">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª CSV</button>
            <button id="m_sample" class="btn ghost">Ù†Ù…ÙˆÙ†Ù‡ CSV</button>
            <button id="m_export" class="btn">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
          </div></div>
        </div>
      `;

        const grades = (await getSetting('Grades') || 'Ø¯Ù‡Ù…,ÛŒØ§Ø²Ø¯Ù‡Ù…,Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…').split(',').map(s => s.trim());
        const fields = (await getSetting('Fields') || 'ØªØ¬Ø±Ø¨ÛŒ,Ø±ÛŒØ§Ø¶ÛŒ,Ø§Ù†Ø³Ø§Ù†ÛŒ').split(',').map(s => s.trim());
        const selG = document.getElementById('m_grade'), selF = document.getElementById('m_field');
        selG.innerHTML = ''; selF.innerHTML = '';
        grades.forEach(g => { const o = document.createElement('option'); o.value = g; o.textContent = g; selG.appendChild(o); });
        fields.forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; selF.appendChild(o); });
        document.getElementById('m_code').value = (await getSetting('NextMemberCode')) || '1000';

        document.getElementById('m_photo').addEventListener('change', async (e) => {
          const f = e.target.files[0]; if (!f) return;
          try { const resized = await resizeImageFile(f, 600, 600, 0.8); document.getElementById('m_preview').src = resized; } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±: ' + err); }
        });

        document.getElementById('m_add').addEventListener('click', async () => {
          const codeEl = document.getElementById('m_code');
          const code = codeEl.value.trim();
          const first = document.getElementById('m_first').value.trim();
          const last = document.getElementById('m_last').value.trim();
          const phone = document.getElementById('m_phone').value.trim();
          if (!code || !first || !last || !phone) { alert('ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'); return; }

          const commitVal = document.querySelector('input[name="m_commit"]:checked') ? document.querySelector('input[name="m_commit"]:checked').value : '0';

          const obj = {
            membershipCode: code, firstName: first, lastName: last, phone,
            nationalCode: document.getElementById('m_national').value.trim(),
            grade: document.getElementById('m_grade').value, field: document.getElementById('m_field').value,
            commitment: String(commitVal) === '1',
            photo: document.getElementById('m_preview').src || '',
            registerDate: (new Date()).toISOString()
          };

          if (!currentEditingMemberId) {
            const r = await addMember(obj);
            if (!r.ok) {
              if (r.error === 'duplicate') alert('Ø®Ø·Ø§: Ú©Ø¯ Ø¹Ø¶ÙˆÛŒØª ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.');
              else alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¹Ø¶Ùˆ â€” ' + (r.error && r.error.message ? r.error.message : r.error));
              return;
            }
            const next = await getSetting('NextMemberCode'); if (next === code) await setSetting('NextMemberCode', String(Number(next) + 1));
            alert('Ø¹Ø¶Ùˆ Ø«Ø¨Øª Ø´Ø¯');
            codeEl.value = (await getSetting('NextMemberCode')) || '';
            document.getElementById('m_first').value = ''; document.getElementById('m_last').value = ''; document.getElementById('m_phone').value = '';
            document.getElementById('m_preview').src = '';
            renderMembersList();
          } else {
            const members = await getMembers(); const m = members.find(x => x.id === currentEditingMemberId);
            if (!m) { alert('Ø¹Ø¶Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
            m.membershipCode = obj.membershipCode; m.firstName = obj.firstName; m.lastName = obj.lastName; m.phone = obj.phone;
            m.nationalCode = obj.nationalCode; m.grade = obj.grade; m.field = obj.field; m.commitment = obj.commitment; m.photo = obj.photo;
            try { await updateMember(m); alert('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); currentEditingMemberId = null; document.getElementById('m_add').textContent = 'Ø«Ø¨Øª Ø¹Ø¶Ùˆ'; renderMembers(); } catch (err) { if (err.message && err.message.includes('duplicate')) alert('Ø®Ø·Ø§: Ú©Ø¯ Ø¹Ø¶ÙˆÛŒØª ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.'); else alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + err); }
          }
        });

        document.getElementById('m_print_current').addEventListener('click', async () => {
          const code = document.getElementById('m_code').value.trim();
          const first = document.getElementById('m_first').value.trim();
          const last = document.getElementById('m_last').value.trim();
          if (!code || !first || !last) { alert('Ø§Ø¨ØªØ¯Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'); return; }
          const temp = { membershipCode: code, firstName: first, lastName: last, phone: document.getElementById('m_phone').value.trim(), photo: document.getElementById('m_preview').src || '', grade: document.getElementById('m_grade').value, field: document.getElementById('m_field').value, commitment: document.querySelector('input[name="m_commit"]:checked')?.value === '1' };
          await printMemberCard(temp);
        });

        document.getElementById('m_sample').addEventListener('click', () => {
          const lines = [
            'membershipCode,firstName,lastName,phone,nationalCode,grade,field,commitment',
            '1001,Ø¹Ù„ÛŒ,Ø±Ø¶Ø§ÛŒÛŒ,09120000000,0011223344,Ø¯Ù‡Ù…,ØªØ¬Ø±Ø¨ÛŒ,Ø¯Ø§Ø±Ø¯',
            '1002,Ø³Ø§Ø±Ø§,Ù‚Ø§Ø³Ù…ÛŒ,09123456789,1122334455,ÛŒØ§Ø²Ø¯Ù‡Ù…,Ø±ÛŒØ§Ø¶ÛŒ,Ù†Ø¯Ø§Ø±Ø¯',
            '1003,Ø±Ø¶Ø§,Ú©Ø§Ø¸Ù…ÛŒ,09350000000,5566778899,Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…,Ø§Ù†Ø³Ø§Ù†ÛŒ,1',
            '1004,Ù…Ø±ÛŒÙ…,Ø¬Ø¹ÙØ±ÛŒ,09198887766,9988776655,Ø¯Ù‡Ù…,ØªØ¬Ø±Ø¨ÛŒ,0'
          ];
          downloadCSV(lines, 'members_sample.csv');
        });

        document.getElementById('m_import').addEventListener('click', () => {
          const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.csv';
          inp.onchange = async (e) => {
            const f = e.target.files[0]; if (!f) return;
            const txt = await f.text();
            const lines = txt.split(/\r?\n/).filter(Boolean);
            if (lines.length === 0) { alert('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'); return; }

            // parse header and map columns
            const headerLine = csvSplitLine(lines[0]);
            const headerNormalized = headerLine.map(h => normalizeHeaderName(h));
            // determine mapping for each column index
            const colMap = {}; // idx -> canonical key
            for (let i = 0; i < headerLine.length; i++) {
              const key = headerToMemberKey(headerLine[i]);
              if (key) colMap[i] = key;
            }

            // if essential keys not found, try Persian exact header names common variant
            if (!Object.values(colMap).includes('firstName') && headerNormalized.some(h => h === normalizeHeaderName('Ù†Ø§Ù…'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ù†Ø§Ù…')); if (idx >= 0) colMap[idx] = 'firstName';
            }
            if (!Object.values(colMap).includes('lastName') && headerNormalized.some(h => h === normalizeHeaderName('Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ')); if (idx >= 0) colMap[idx] = 'lastName';
            }
            if (!Object.values(colMap).includes('phone') && headerNormalized.some(h => h === normalizeHeaderName('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³')); if (idx >= 0) colMap[idx] = 'phone';
            }
            if (!Object.values(colMap).includes('nationalCode') && headerNormalized.some(h => h === normalizeHeaderName('Ú©Ø¯ Ù…Ù„ÛŒ'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ú©Ø¯ Ù…Ù„ÛŒ')); if (idx >= 0) colMap[idx] = 'nationalCode';
            }
            if (!Object.values(colMap).includes('commitment') && headerNormalized.some(h => h === normalizeHeaderName('ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡')); if (idx >= 0) colMap[idx] = 'commitment';
            }
            if (!Object.values(colMap).includes('commitment') && headerNormalized.some(h => h === normalizeHeaderName('ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡'.replace(/\s+/g, '')))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡')); if (idx >= 0) colMap[idx] = 'commitment';
            }
            if (!Object.values(colMap).includes('field') && headerNormalized.some(h => h === normalizeHeaderName('Ø±Ø´ØªÙ‡'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ø±Ø´ØªÙ‡')); if (idx >= 0) colMap[idx] = 'field';
            }
            if (!Object.values(colMap).includes('grade') && headerNormalized.some(h => h === normalizeHeaderName('Ù¾Ø§ÛŒÙ‡'))) {
              const idx = headerNormalized.indexOf(normalizeHeaderName('Ù¾Ø§ÛŒÙ‡')); if (idx >= 0) colMap[idx] = 'grade';
            }

            // decide whether first row is header: if we mapped at least one known field, treat as header
            const hasHeader = Object.keys(colMap).length > 0;
            let startIdx = hasHeader ? 1 : 0;

            let added = 0, skipped = 0;
            // prepare next member code for auto-generation if membershipCode missing
            let nextCode = Number(await getSetting('NextMemberCode') || '1000');

            for (let i = startIdx; i < lines.length; i++) {
              const p = csvSplitLine(lines[i]);
              // build member object using mapping; if no header mapping, use positional order:
              // positional assumption (if no header): firstName, lastName, phone, nationalCode, commitment, field, grade
              let obj = null;
              if (hasHeader) {
                const rec = {};
                for (let c = 0; c < p.length; c++) {
                  const key = colMap[c];
                  if (!key) continue;
                  rec[key] = p[c] !== undefined ? p[c].trim() : '';
                }
                const membershipCode = (rec['membershipCode'] || '').trim() || String(nextCode);
                obj = {
                  membershipCode: membershipCode,
                  firstName: (rec['firstName'] || '').trim(),
                  lastName: (rec['lastName'] || '').trim(),
                  phone: (rec['phone'] || '').trim(),
                  nationalCode: (rec['nationalCode'] || '').trim(),
                  grade: (rec['grade'] || '').trim(),
                  field: (rec['field'] || '').trim(),
                  commitment: normalizeTaahodValue(rec['commitment'] || ''),
                  photo: '',
                  registerDate: (new Date()).toISOString()
                };
              } else {
                if (p.length < 3) { skipped++; continue; }
                obj = {
                  membershipCode: String(nextCode),
                  firstName: p[0].trim(),
                  lastName: p[1].trim(),
                  phone: p[2].trim(),
                  nationalCode: p[3]?.trim() || '',
                  grade: p[6]?.trim() || '',
                  field: p[5]?.trim() || '',
                  commitment: normalizeTaahodValue(p[4] || ''),
                  photo: '',
                  registerDate: (new Date()).toISOString()
                };
              }

              if (!obj.membershipCode) obj.membershipCode = String(nextCode);
              if (!obj.firstName || !obj.lastName || !obj.phone) { skipped++; continue; }

              // attempt to add; if duplicate membershipCode, auto-increment code and retry a few times
              let tries = 0; let r;
              while (tries < 6) {
                try {
                  r = await addMember(obj);
                  if (r.ok) break;
                  if (r.error === 'duplicate') {
                    nextCode = nextCode + 1;
                    obj.membershipCode = String(nextCode);
                    tries++;
                    continue;
                  } else {
                    break;
                  }
                } catch (err) {
                  r = { ok: false, error: err };
                  break;
                }
              }
              if (r && r.ok) { added++; nextCode = Number(obj.membershipCode) + 1; }
              else skipped++;
            }

            // persist updated NextMemberCode
            await setSetting('NextMemberCode', String(nextCode));

            alert(`Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ ${added}ØŒ Ø±Ø¯ Ø´Ø¯Ù‡ ${skipped}`);
            renderMembersList();
          };
          inp.click();
        });

        document.getElementById('m_export').addEventListener('click', async () => {
          const ms = await getMembers();
          const lines = ms.map(m => [m.firstName, m.lastName, m.phone, m.nationalCode, (m.commitment ? 'Ø¯Ø§Ø±Ø¯' : 'Ù†Ø¯Ø§Ø±Ø¯'), m.field, m.grade, m.membershipCode].map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(','));
          // include header as the user requested order: Ù†Ø§Ù…, Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ, Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³, Ú©Ø¯ Ù…Ù„ÛŒ, ØªØ¹Ù‡Ø¯ Ù†Ø§Ù…Ù‡, Ø±Ø´ØªÙ‡, Ù¾Ø§ÛŒÙ‡, membershipCode
          lines.unshift('"Ù†Ø§Ù…","Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ","Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³","Ú©Ø¯ Ù…Ù„ÛŒ","ØªØ¹Ù‡Ø¯ Ù†Ø§Ù…Ù‡","Ø±Ø´ØªÙ‡","Ù¾Ø§ÛŒÙ‡","membershipCode"');
          downloadCSV(lines, 'members_export.csv');
        });

        renderMembersList();
      }

      async function renderMembersList({ page = 1, pageSize = 25, q = '' } = {}) {
        const members = (await getMembers()).filter(m => { if (!q) return true; const s = (m.membershipCode + ' ' + m.firstName + ' ' + m.lastName + ' ' + (m.phone || '') + ' ' + (m.nationalCode || '')).toLowerCase(); return s.includes(q.toLowerCase()); });
        const total = members.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * pageSize; const slice = members.slice(start, start + pageSize);
        main.innerHTML = `
        <div class="small">Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§ (${total})</div>
        <div class="searchRow" style="margin-top:8px">
          <input id="memberSearch" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø­Ø³Ø¨ Ù†Ø§Ù…ØŒÚ©Ø¯ØŒØªÙ„ÙÙ†..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" value="${escapeHtml(q)}" />
          <select id="memberPageSize">
            <option ${pageSize == 10 ? 'selected' : ''}>10</option>
            <option ${pageSize == 25 ? 'selected' : ''}>25</option>
            <option ${pageSize == 50 ? 'selected' : ''}>50</option>
          </select>
        </div>
        <div class="list-scroll" style="margin-top:10px;overflow:auto;max-height:520px">
          <table><thead><tr><th>Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ø±Ø´ØªÙ‡</th><th>ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
            <tbody>
            ${slice.map(m => `<tr data-id="${m.id}"><td>${escapeHtml(m.membershipCode)}</td><td>${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)}</td><td>${escapeHtml(m.phone)}</td><td>${escapeHtml(m.grade)}</td><td>${escapeHtml(m.field)}</td><td>${m.commitment ? '<span class="commit-yes">âœ”</span>' : '<span class="commit-no">Ã—</span>'}</td><td><button class="edit op" data-id="${m.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button> <button class="printCard op" data-id="${m.id}">Ú†Ø§Ù¾ Ú©Ø§Ø±Øª</button> <button class="del op" data-id="${m.id}">Ø­Ø°Ù</button></td></tr>`).join('')}
            </tbody></table>
        </div>
        <div class="pagination" style="margin-top:8px;display:flex;align-items:center;gap:8px">
          <div class="small">ØµÙØ­Ù‡ ${page} Ø§Ø² ${totalPages}</div>
          <div style="flex:1"></div>
          <button class="pager-btn" id="prevPage" ${page <= 1 ? 'disabled' : ''}>â—€ Ù‚Ø¨Ù„ÛŒ</button>
          <button class="pager-btn" id="nextPage" ${page >= totalPages ? 'disabled' : ''}>Ø¨Ø¹Ø¯ÛŒ â–¶</button>
        </div>
      `;
        document.getElementById('memberSearch').addEventListener('input', (e) => renderMembersList({ page: 1, pageSize: Number(document.getElementById('memberPageSize').value || 25), q: e.target.value }));
        document.getElementById('memberPageSize').addEventListener('change', (e) => renderMembersList({ page: 1, pageSize: Number(e.target.value || 25), q: document.getElementById('memberSearch').value }));
        document.getElementById('prevPage').addEventListener('click', () => renderMembersList({ page: Math.max(1, page - 1), pageSize, q }));
        document.getElementById('nextPage').addEventListener('click', () => renderMembersList({ page: Math.min(totalPages, page + 1), pageSize, q }));

        main.querySelectorAll('button.edit').forEach(b => b.addEventListener('click', async (e) => {
          const id = Number(b.dataset.id); const members = await getMembers(); const m = members.find(x => x.id === id); if (!m) return;
          document.getElementById('m_code').value = m.membershipCode;
          document.getElementById('m_first').value = m.firstName;
          document.getElementById('m_last').value = m.lastName;
          document.getElementById('m_phone').value = m.phone;
          document.getElementById('m_national').value = m.nationalCode || '';
          document.getElementById('m_grade').value = m.grade || '';
          document.getElementById('m_field').value = m.field || '';
          document.querySelectorAll('input[name="m_commit"]').forEach(r => { r.checked = (r.value === (m.commitment ? '1' : '0')); });
          document.getElementById('m_preview').src = m.photo || '';
          currentEditingMemberId = m.id;
          const addBtn = document.getElementById('m_add'); addBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
        }));

        main.querySelectorAll('button.del').forEach(b => b.addEventListener('click', async (e) => {
          if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
          const id = Number(b.dataset.id); await deleteMember(id); renderMembersList();
        }));

        main.querySelectorAll('button.printCard').forEach(b => b.addEventListener('click', async (e) => {
          const id = Number(b.dataset.id); const members = await getMembers(); const m = members.find(x => x.id === id);
          if (!m) return; await printMemberCard(m);
        }));
      }

      /* ========== Books ========== */
      async function renderBooks() {
        currentEditingBookId = null;
        panelContent.innerHTML = `
        <div class="small">ÙØ±Ù… Ø«Ø¨Øª Ú©ØªØ§Ø¨</div>
        <div style="margin-top:8px">
          <div class="form-row"><label>Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª</label><div class="field"><input id="b_reg" type="text" /></div></div>
          <div class="form-row"><label>Ù†Ø§Ù… Ú©ØªØ§Ø¨</label><div class="field"><input id="b_title" type="text" /></div></div>
          <div class="form-row"><label>Ø§Ø®ØªØµØ§Ø±</label><div class="field"><input id="b_abbr" type="text" /></div></div>
          <div class="form-row"><label>Ù¾Ø§ÛŒÙ‡</label><div class="field"><select id="b_grade" class="fancy"></select></div></div>
          <div class="form-row"><label>Ø±Ø´ØªÙ‡</label><div class="field"><select id="b_field" class="fancy"></select></div></div>
          <div class="form-row"><label>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„</label><div class="field"><input id="b_total" type="number" min="1" value="1" /></div></div>
          <div class="form-row"><label></label><div class="controls"><button id="b_add" class="btn primary">Ø«Ø¨Øª Ú©ØªØ§Ø¨</button><button id="b_import" class="btn">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª CSV</button><button id="b_sample" class="btn ghost">Ù†Ù…ÙˆÙ†Ù‡ CSV</button><button id="b_export" class="btn">Ø®Ø±ÙˆØ¬ÛŒ CSV</button></div></div>
        </div>
      `;
        const grades = (await getSetting('Grades') || 'Ø¯Ù‡Ù…,ÛŒØ§Ø²Ø¯Ù‡Ù…,Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…').split(',').map(s => s.trim());
        const fields = (await getSetting('Fields') || 'Ø±ÛŒØ§Ø¶ÛŒ,ØªØ¬Ø±Ø¨ÛŒ,Ø§Ù†Ø³Ø§Ù†ÛŒ').split(',').map(s => s.trim());
        const selG = document.getElementById('b_grade'), selF = document.getElementById('b_field');
        selG.innerHTML = ''; selF.innerHTML = '';
        grades.forEach(g => { const o = document.createElement('option'); o.value = g; o.textContent = g; selG.appendChild(o); });
        fields.forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; selF.appendChild(o); });
        document.getElementById('b_reg').value = (await getSetting('NextBookReg')) || '1000';

        // book save handler (add or update)
        document.getElementById('b_add').addEventListener('click', async () => {
          const reg = document.getElementById('b_reg').value.trim();
          const title = document.getElementById('b_title').value.trim();
          if (!reg || !title) { alert('ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'); return; }
          let tot = Number(document.getElementById('b_total').value || 0); if (!Number.isFinite(tot) || tot < 1) tot = 1;
          const obj = { regNumber: reg, title, abbr: document.getElementById('b_abbr').value.trim(), grade: document.getElementById('b_grade').value, field: document.getElementById('b_field').value, total: tot, available: tot };

          if (!currentEditingBookId) {
            const r = await addBook(obj);
            if (!r.ok) { if (r.error === 'duplicate') alert('Ø®Ø·Ø§: Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.'); else alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ â€” ' + (r.error && r.error.message ? r.error.message : r.error)); return; }
            const next = await getSetting('NextBookReg'); if (next === reg) await setSetting('NextBookReg', String(Number(next) + 1));
            alert('Ú©ØªØ§Ø¨ Ø«Ø¨Øª Ø´Ø¯'); renderBooksList();
            document.getElementById('b_reg').value = (await getSetting('NextBookReg')) || '';
            document.getElementById('b_title').value = ''; document.getElementById('b_abbr').value = ''; document.getElementById('b_total').value = '1';
          } else {
            const books = await getBooks(); const b = books.find(x => x.id === currentEditingBookId);
            if (!b) { alert('Ú©ØªØ§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
            const oldTotal = Number(b.total || 0);
            const newTotal = Math.max(1, Number(document.getElementById('b_total').value || 1));
            b.regNumber = obj.regNumber; b.title = obj.title; b.abbr = obj.abbr;
            const delta = newTotal - oldTotal;
            b.total = newTotal;
            b.available = (b.available || 0) + delta;
            if (b.available > b.total) b.available = b.total;
            if (b.available < 0) b.available = 0;
            b.grade = obj.grade; b.field = obj.field;
            try { await updateBook(b); alert('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); currentEditingBookId = null; document.getElementById('b_add').textContent = 'Ø«Ø¨Øª Ú©ØªØ§Ø¨'; renderBooks(); } catch (err) { if (err.message && err.message.includes('duplicate')) alert('Ø®Ø·Ø§: Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.'); else alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + err); }
          }
        });

        document.getElementById('b_sample').addEventListener('click', () => {
          const lines = [
            'regNumber,title,abbr,grade,field,total',
            '2001,Ø±ÛŒØ§Ø¶ÛŒ Ù¾Ø§ÛŒÙ‡,Ø±ÛŒØ§Ø¶ÛŒ,Ø¯Ù‡Ù…,ØªØ¬Ø±Ø¨ÛŒ,3'
          ];
          downloadCSV(lines, 'books_sample.csv');
        });

        document.getElementById('b_import').addEventListener('click', () => {
          const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.csv';
          inp.onchange = async (e) => {
            const f = e.target.files[0]; if (!f) return;
            const txt = await f.text(); const lines = txt.split(/\r?\n/).filter(Boolean);
            let added = 0, skipped = 0;
            let startIdx = 0;
            const headerRow = csvSplitLine(lines[0]).map(h => h.toString().trim().toLowerCase());
            const hasHeader = headerRow.some(h => ['regnumber', 'title', 'abbr', 'grade', 'field', 'total'].includes(h));
            if (hasHeader) startIdx = 1;
            for (let i = startIdx; i < lines.length; i++) {
              const p = csvSplitLine(lines[i]);
              if (p.length >= 2) {
                let tot = 1;
                if (startIdx === 1) {
                  const map = {};
                  headerRow.forEach((h, idx) => map[h] = p[idx] || '');
                  tot = Number(map['total'] || 1) || 1;
                  const obj = { regNumber: (map['regnumber'] || map['reg'] || '').trim(), title: (map['title'] || '').trim(), abbr: (map['abbr'] || '').trim(), grade: (map['grade'] || '').trim(), field: (map['field'] || '').trim(), total: tot, available: tot };
                  if (!obj.regNumber || !obj.title) { skipped++; continue; }
                  const r = await addBook(obj); if (r.ok) added++; else skipped++;
                } else {
                  tot = p[5] ? Number(p[5]) : NaN; if (!Number.isFinite(tot) || tot < 1) tot = 1;
                  const obj = { regNumber: p[0].trim(), title: p[1].trim(), abbr: p[2]?.trim() || '', grade: p[3]?.trim() || '', field: p[4]?.trim() || '', total: tot, available: tot };
                  const r = await addBook(obj); if (r.ok) added++; else skipped++;
                }
              } else skipped++;
            }
            alert(`Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ ${added}ØŒ Ø±Ø¯ Ø´Ø¯Ù‡ ${skipped}`);
            renderBooksList();
          };
          inp.click();
        });

        document.getElementById('b_export').addEventListener('click', async () => {
          const bs = await getBooks();
          const lines = bs.map(b => [b.regNumber, b.title, b.abbr, b.grade, b.field, b.total, b.available].map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(','));
          lines.unshift('"regNumber","title","abbr","grade","field","total","available"');
          downloadCSV(lines, 'books_export.csv');
        });

        renderBooksList();
      }

      async function renderBooksList({ page = 1, pageSize = 25, q = '' } = {}) {
        const books = (await getBooks()).filter(b => { if (!q) return true; const s = (b.regNumber + ' ' + b.title + ' ' + (b.abbr || '')).toLowerCase(); return s.includes(q.toLowerCase()); });
        const total = books.length; const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * pageSize; const slice = books.slice(start, start + pageSize);
        main.innerHTML = `
        <div class="small">Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ (${total})</div>
        <div class="searchRow" style="margin-top:8px">
          <input id="bookSearch" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" value="${escapeHtml(q)}" />
          <select id="bookPageSize">
            <option ${pageSize == 10 ? 'selected' : ''}>10</option>
            <option ${pageSize == 25 ? 'selected' : ''}>25</option>
            <option ${pageSize == 50 ? 'selected' : ''}>50</option>
          </select>
        </div>
        <div class="list-scroll" style="margin-top:8px;overflow:auto;max-height:480px">
          <table><thead><tr><th>Ø±Ø¬ÛŒØ³ØªØ±</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ø®ØªØµØ§Ø±</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ø±Ø´ØªÙ‡</th><th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
            <tbody>
            ${slice.map(b => `<tr data-id="${b.id}"><td>${escapeHtml(b.regNumber)}</td><td>${escapeHtml(b.title)}</td><td>${escapeHtml(b.abbr)}</td><td>${escapeHtml(b.grade)}</td><td>${escapeHtml(b.field)}</td><td>${(b.available || 0)}/${(b.total || 0)}</td><td><button class="editb op" data-id="${b.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button> <button class="delb op" data-id="${b.id}">Ø­Ø°Ù</button></td></tr>`).join('')}
            </tbody></table>
        </div>
        <div class="pagination">
          <div class="small">ØµÙØ­Ù‡ ${page} Ø§Ø² ${totalPages}</div>
          <div style="flex:1"></div>
          <button class="pager-btn" id="prevPageB" ${page <= 1 ? 'disabled' : ''}>â—€ Ù‚Ø¨Ù„ÛŒ</button>
          <button class="pager-btn" id="nextPageB" ${page >= totalPages ? 'disabled' : ''}>Ø¨Ø¹Ø¯ÛŒ â–¶</button>
        </div>
      `;
        document.getElementById('bookSearch').addEventListener('input', (e) => renderBooksList({ page: 1, pageSize: Number(document.getElementById('bookPageSize').value || 25), q: e.target.value }));
        document.getElementById('bookPageSize').addEventListener('change', (e) => renderBooksList({ page: 1, pageSize: Number(e.target.value || 25), q: document.getElementById('bookSearch').value }));
        document.getElementById('prevPageB').addEventListener('click', () => renderBooksList({ page: Math.max(1, page - 1), pageSize, q }));
        document.getElementById('nextPageB').addEventListener('click', () => renderBooksList({ page: Math.min(totalPages, page + 1), pageSize, q }));

        main.querySelectorAll('button.editb').forEach(btn => btn.addEventListener('click', async () => {
          const id = Number(btn.dataset.id); const books = await getBooks(); const b = books.find(x => x.id === id); if (!b) return;
          document.getElementById('b_reg').value = b.regNumber;
          document.getElementById('b_title').value = b.title;
          document.getElementById('b_abbr').value = b.abbr;
          document.getElementById('b_total').value = b.total || 1;
          currentEditingBookId = b.id;
          const addBtn = document.getElementById('b_add'); addBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
        }));
        main.querySelectorAll('button.delb').forEach(btn => btn.addEventListener('click', async () => {
          if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return; const id = Number(btn.dataset.id); await deleteBook(id); renderBooksList();
        }));
      }

      /* ========== Loans ========== */
      function debounceFunc(fn, wait = 200) { let t = null; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }

      async function renderLoans() {
        panelContent.innerHTML = `
        <div class="small">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</div>
        <div style="margin-top:8px">
          <div class="form-row" style="flex-direction:column;align-items:stretch"><label style="min-width:unset">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¹Ø¶Ùˆ</label><div class="field"><input id="loan_member_search" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ú©Ø¯ ÛŒØ§ ØªÙ„ÙÙ†..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" /></div></div>
          <div class="form-row"><label>Ø¹Ø¶Ùˆ</label><div class="field"><select id="loan_member" class="fancy"></select></div></div>

          <div style="height:6px"></div>

          <div class="form-row" style="flex-direction:column;align-items:stretch"><label style="min-width:unset">Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©ØªØ§Ø¨</label><div class="field"><input id="loan_book_search" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" /></div></div>
          <div class="form-row"><label>Ú©ØªØ§Ø¨</label><div class="field"><select id="loan_book" class="fancy"></select></div></div>

          <div class="form-row"><label></label><div class="controls"><button id="loan_issue" class="btn primary">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button><button id="loan_return" class="btn">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button><button id="loan_delete" class="btn ghost">Ø­Ø°Ù Ø§Ù…Ø§Ù†Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button></div></div>
        </div>
      `;
        await populateLoanSelects('', '');
        const memSearch = document.getElementById('loan_member_search');
        const bookSearch = document.getElementById('loan_book_search');
        const doPopulateDebounced = debounceFunc(async () => {
          const mq = memSearch.value.trim(); const bq = bookSearch.value.trim();
          const prevMember = document.getElementById('loan_member') ? document.getElementById('loan_member').value : null;
          const prevBook = document.getElementById('loan_book') ? document.getElementById('loan_book').value : null;
          await populateLoanSelects(mq, bq);
          if (prevMember) { const newSelM = document.getElementById('loan_member'); if (newSelM) { const opt = Array.from(newSelM.options).find(o => o.value === prevMember); if (opt) newSelM.value = prevMember; } }
          if (prevBook) { const newSelB = document.getElementById('loan_book'); if (newSelB) { const opt = Array.from(newSelB.options).find(o => o.value === prevBook); if (opt) newSelB.value = prevBook; } }
        }, 180);
        memSearch.addEventListener('input', doPopulateDebounced);
        bookSearch.addEventListener('input', doPopulateDebounced);

        document.getElementById('loan_issue').addEventListener('click', async () => {
          const memberId = Number(document.getElementById('loan_member').value);
          const bookId = Number(document.getElementById('loan_book').value);
          if (!memberId || !bookId) { alert('Ø¹Ø¶Ùˆ Ùˆ Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
          const members = await getMembers(); const m = members.find(x => x.id === memberId);
          const books = await getBooks(); const b = books.find(x => x.id === bookId);
          const max = Number(await getSetting('MaxBooksPerMember') || 3);
          const active = (await getLoans()).filter(x => x.memberId === memberId && !x.isReturned).length;
          if (active + 1 > max) { alert('Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ù…Ø§Ù†Øª Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¹Ø¶Ùˆ Ù¾Ø± Ø´Ø¯Ù‡'); return; }
          if (!b || (b.available || 0) <= 0) { alert('Ø§ÛŒÙ† Ú©ØªØ§Ø¨ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'); return; }
          const days = Number(await getSetting('LoanDaysDefault') || 10);
          const issue = new Date(); const due = new Date(issue.getTime() + days * 24 * 3600 * 1000);
          const obj = { memberId, memberName: m.firstName + ' ' + m.lastName, bookId, bookTitle: b.title, issueISO: issue.toISOString(), dueISO: due.toISOString(), isReturned: false };
          await addLoan(obj);
          showToast('Ø§Ù…Ø§Ù†Øª Ø«Ø¨Øª Ø´Ø¯ â€” ' + nowShamsiFull());
          renderLoansList(); await populateLoanSelects('', '');
        });

        document.getElementById('loan_return').addEventListener('click', async () => {
          const checkboxes = document.querySelectorAll('input.loancheck:checked');
          if (checkboxes.length === 0) { alert('Ø§Ø¨ØªØ¯Ø§ Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø§Ù…Ø§Ù†Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
          for (const cb of checkboxes) { const id = Number(cb.dataset.id); await returnLoan(id); }
          alert('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); renderLoansList(); await populateLoanSelects('', '');
        });

        document.getElementById('loan_delete').addEventListener('click', async () => {
          const checkboxes = document.querySelectorAll('input.loancheck:checked');
          if (checkboxes.length === 0) { alert('Ø§Ø¨ØªØ¯Ø§ Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø§Ù…Ø§Ù†Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
          if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ù…Ø§Ù†Øª(Ù‡Ø§) Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ (Ø¯Ø± ØµÙˆØ±Øª Ø­Ø°ÙØŒ ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ØªØ§Ø¨ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)')) return;
          for (const cb of checkboxes) { const id = Number(cb.dataset.id); await deleteLoan(id); }
          alert('Ø­Ø°Ù Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); renderLoansList(); await populateLoanSelects('', '');
        });

        renderLoansList();
      }

      async function populateLoanSelects(memberQuery = '', bookQuery = '') {
        const members = await getMembers(); const books = await getBooks();
        const selM = document.getElementById('loan_member'); const selB = document.getElementById('loan_book');
        if (!selM || !selB) return;
        const mq = String(memberQuery || '').trim().toLowerCase(); const bq = String(bookQuery || '').trim().toLowerCase();
        const filteredMembers = members.filter(m => { if (!mq) return true; const s = `${m.membershipCode} ${m.firstName} ${m.lastName} ${m.phone || ''} ${m.nationalCode || ''}`.toLowerCase(); return s.includes(mq); });
        const filteredBooks = books.filter(b => { if (!bq) return true; const s = `${b.regNumber} ${b.title} ${b.abbr || ''}`.toLowerCase(); return s.includes(bq); });
        selM.innerHTML = ''; filteredMembers.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = `${m.firstName} ${m.lastName} (${m.membershipCode}) ${m.phone ? 'â€” ' + m.phone : ''}`; selM.appendChild(o); });
        if (filteredMembers.length === 0) { const o = document.createElement('option'); o.value = ''; o.textContent = 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯'; selM.appendChild(o); }
        selB.innerHTML = ''; filteredBooks.sort((x, y) => ((y.available || 0) - (x.available || 0))); filteredBooks.forEach(b => { const o = document.createElement('option'); o.value = b.id; o.textContent = `${b.title} [${b.regNumber}] â€” Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${(b.available || 0)}/${(b.total || 0)}`; selB.appendChild(o); });
        if (filteredBooks.length === 0) { const o = document.createElement('option'); o.value = ''; o.textContent = 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯'; selB.appendChild(o); }
      }

      async function renderLoansList() {
        const loans = await getLoans();
        main.innerHTML = `<div class="small">Ù„ÛŒØ³Øª Ø§Ù…Ø§Ù†Ø§Øª (${loans.length})</div><div style="margin-top:8px;max-height:520px;overflow:auto" class="list-scroll"><table><thead><tr><th></th><th>Ø¹Ø¶Ùˆ</th><th>Ú©ØªØ§Ø¨</th><th>Ø«Ø¨Øª</th><th>Ù…Ù‡Ù„Øª</th><th>Ø¨Ø§Ø²Ú¯Ø´Øª</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead><tbody>${loans.map(l => `<tr><td><input class="loancheck" data-id="${l.id}" type="checkbox" /></td><td>${escapeHtml(l.memberName)}</td><td>${escapeHtml(l.bookTitle)}</td><td>${toShamsiStr(l.issueISO)}</td><td>${toShamsiStr(l.dueISO)}</td><td>${l.returnDate ? toShamsiStr(l.returnDate) : ''}</td><td>${l.isReturned ? 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡' : (new Date(l.dueISO) < new Date() ? '<span style="color:var(--danger)">Ø¯ÛŒØ±Ú©Ø±Ø¯</span>' : 'Ø¬Ø§Ø±ÛŒ')}</td></tr>`).join('')}</tbody></table></div>`;
      }

      function toShamsiStr(iso) { if (!iso) return ''; const d = new Date(iso); const [y, m, day] = toJalali(d.getFullYear(), d.getMonth() + 1, d.getDate()); return `${y}/${String(m).padStart(2, '0')}/${String(day).padStart(2, '0')}`; }

      /* ========== Reports ========== */

      function cleanPrintableContent(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;

        temp.querySelectorAll('.list-scroll').forEach(el => {
          const tbl = el.querySelector('table');
          const wrapper = document.createElement('div');
          wrapper.style.overflow = 'visible';
          wrapper.style.maxHeight = 'none';
          wrapper.style.height = 'auto';
          wrapper.style.boxSizing = 'border-box';
          wrapper.style.width = '100%';
          if (tbl) wrapper.appendChild(tbl.cloneNode(true));
          else wrapper.innerHTML = el.innerHTML;
          el.parentNode.replaceChild(wrapper, el);
        });

        temp.querySelectorAll('[style]').forEach(node => {
          let s = node.getAttribute('style') || '';
          s = s.replace(/max-height:[^;]+;?/gi, '');
          s = s.replace(/overflow:[^;]+;?/gi, '');
          s = s.replace(/height:[^;]+;?/gi, '');
          s = s.replace(/page-break-after:[^;]+;?/gi, '');
          node.setAttribute('style', s.trim());
        });

        return temp.innerHTML;
      }

      /**
       * createPrintablePages:
       * - headerHTML: string shown at top of each page (optional)
       * - contentHTML: cleaned content (usually returned from cleanPrintableContent)
       * - rowsPerPage: how many table rows per printed page (default 30)
       *
       * This function builds multiple <div class="print-page">...</div> and injects into #printArea
       */
      async function createPrintablePages(headerHTML, contentHTML, rowsPerPage = 30) {
        const printAreaEl = document.getElementById('printArea');
        printAreaEl.innerHTML = '';

        const temp = document.createElement('div');
        temp.innerHTML = contentHTML;

        // extract non-table content (intro, paragraphs, titles)
        const nonTableWrapper = document.createElement('div');
        nonTableWrapper.innerHTML = temp.innerHTML;
        nonTableWrapper.querySelectorAll('table').forEach(n => n.remove());
        const nonTableHtml = nonTableWrapper.innerHTML.trim();

        // collect tables
        const tables = Array.from(temp.querySelectorAll('table'));

        const pages = [];

        // if there is non-table content, make it the first page (if it's not empty)
        if (nonTableHtml) {
          pages.push(`<div class="print-page">${headerHTML || ''}<div>${nonTableHtml}</div></div>`);
        }

        // helper: get thead html (if exists)
        function getTheadHtml(tbl) {
          const th = tbl.querySelector('thead');
          return th ? th.outerHTML : '';
        }

        // for each table, split rows into pages
        for (const tbl of tables) {
          const theadHtml = getTheadHtml(tbl);
          const rows = Array.from(tbl.querySelectorAll('tbody tr'));
          // if no tbody rows found, fallback to all tr
          if (rows.length === 0) {
            const allRows = Array.from(tbl.querySelectorAll('tr'));
            if (allRows.length > 0) {
              // treat first as header if it contains th
              const first = allRows[0];
              if (first.querySelectorAll('th').length > 0) {
                // header present
                const rest = allRows.slice(1);
                for (let i = 0; i < rest.length; i += rowsPerPage) {
                  const chunk = rest.slice(i, i + rowsPerPage);
                  const tbodyHtml = `<tbody>${chunk.map(r => r.outerHTML).join('')}</tbody>`;
                  pages.push(`<div class="print-page">${headerHTML || ''}<div>${'<table style="width:100%;border-collapse:collapse">' + first.outerHTML + tbodyHtml + '</table>'}</div></div>`);
                }
              } else {
                // no header, just chunk rows
                for (let i = 0; i < allRows.length; i += rowsPerPage) {
                  const chunk = allRows.slice(i, i + rowsPerPage);
                  const tbodyHtml = `<tbody>${chunk.map(r => r.outerHTML).join('')}</tbody>`;
                  pages.push(`<div class="print-page">${headerHTML || ''}<div>${'<table style="width:100%;border-collapse:collapse">' + tbodyHtml + '</table>'}</div></div>`);
                }
              }
            } else {
              // empty table (skip)
            }
          } else {
            // we have tbody rows
            for (let i = 0; i < rows.length; i += rowsPerPage) {
              const chunk = rows.slice(i, i + rowsPerPage);
              const tbodyHtml = `<tbody>${chunk.map(r => r.outerHTML).join('')}</tbody>`;
              pages.push(`<div class="print-page">${headerHTML || ''}<div>${'<table style="width:100%;border-collapse:collapse">' + theadHtml + tbodyHtml + '</table>'}</div></div>`);
            }
          }
        }

        // if no tables and no non-table content (empty), show placeholder
        if (pages.length === 0) {
          pages.push(`<div class="print-page">${headerHTML || ''}<div class="small">Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div></div>`);
        }

        printAreaEl.innerHTML = pages.join('\n');

        // return number of pages produced
        return printAreaEl.querySelectorAll('.print-page').length;
      }

      /* ========== renderReports (updated to use createPrintablePages) ========== */
      async function renderReports() {
        panelContent.innerHTML = `
        <div class="small">Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø²Ø§Ø±Ø´</div>
        <div style="margin-top:8px" class="flow">
          <button class="btn" data-r="members">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø§Ø¹Ø¶Ø§</button>
          <button class="btn" data-r="books">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
          <button class="btn" data-r="available">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯</button>
          <button class="btn" data-r="loans">Ø§Ù…Ø§Ù†Ø§Øª Ø¬Ø§Ø±ÛŒ</button>
          <button class="btn" data-r="due">Ù…Ù‡Ù„Øª Ø§Ù…Ø±ÙˆØ²/ÙØ±Ø¯Ø§</button>
          <button class="btn primary" id="printReport">Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</button>
        </div>
      `;
        panelContent.querySelectorAll('button.btn').forEach(b => {
          b.addEventListener('click', async () => {
            const t = b.dataset.r;
            if (!t) return;
            if (t === 'members') { const m = await getMembers(); main.innerHTML = `<div class="list-scroll" style="max-height:520px;overflow:auto"><table><thead><tr><th>Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>ØªÙ„ÙÙ†</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ø±Ø´ØªÙ‡</th><th>ØªØ¹Ù‡Ø¯Ù†Ø§Ù…Ù‡</th></tr></thead><tbody>${m.map(x => `<tr><td>${escapeHtml(x.membershipCode)}</td><td>${escapeHtml(x.firstName)} ${escapeHtml(x.lastName)}</td><td>${escapeHtml(x.phone)}</td><td>${escapeHtml(x.grade)}</td><td>${escapeHtml(x.field)}</td><td>${x.commitment ? '<span class="commit-yes">âœ”</span>' : '<span class="commit-no">Ã—</span>'}</td></tr>`).join('')}</tbody></table></div>`; }
            if (t === 'books') { const bks = await getBooks(); main.innerHTML = `<div class="list-scroll" style="max-height:520px;overflow:auto"><table><thead><tr><th>Ø±Ø¬ÛŒØ³ØªØ±</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ø±Ø´ØªÙ‡</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù…ÙˆØ¬ÙˆØ¯</th></tr></thead><tbody>${bks.map(x => `<tr><td>${escapeHtml(x.regNumber)}</td><td>${escapeHtml(x.title)}</td><td>${escapeHtml(x.grade)}</td><td>${escapeHtml(x.field)}</td><td>${x.total}</td><td>${x.available}</td></tr>`).join('')}</tbody></table></div>`; }
            if (t === 'available') { const bks = (await getBooks()).filter(x => x.available > 0); main.innerHTML = `<div class="list-scroll" style="max-height:520px;overflow:auto"><table><thead><tr><th>Ø±Ø¬ÛŒØ³ØªØ±</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ù…ÙˆØ¬ÙˆØ¯</th></tr></thead><tbody>${bks.map(x => `<tr><td>${escapeHtml(x.regNumber)}</td><td>${escapeHtml(x.title)}</td><td>${x.available}</td></tr>`).join('')}</tbody></table></div>`; }
            if (t === 'loans') { const loans = (await getLoans()).filter(l => !l.isReturned); main.innerHTML = `<div class="list-scroll" style="max-height:520px;overflow:auto"><table><thead><tr><th>Ø¹Ø¶Ùˆ</th><th>Ú©ØªØ§Ø¨</th><th>Ø«Ø¨Øª</th><th>Ù…Ù‡Ù„Øª</th></tr></thead><tbody>${loans.map(l => `<tr><td>${escapeHtml(l.memberName)}</td><td>${escapeHtml(l.bookTitle)}</td><td>${toShamsiStr(l.issueISO)}</td><td>${toShamsiStr(l.dueISO)}</td></tr>`).join('')}</tbody></table></div>`; }
            if (t === 'due') {
              const now = new Date(); const tomorrowDate = new Date(now.getTime() + 24 * 3600 * 1000);
              const loans = (await getLoans()).filter(l => !l.isReturned).filter(l => { const d = new Date(l.dueISO); return d.toDateString() === now.toDateString() || d.toDateString() === tomorrowDate.toDateString(); });
              main.innerHTML = `<div class="list-scroll" style="max-height:520px;overflow:auto"><table><thead><tr><th>Ø¹Ø¶Ùˆ</th><th>Ú©ØªØ§Ø¨</th><th>Ù…Ù‡Ù„Øª</th></tr></thead><tbody>${loans.map(l => `<tr><td>${escapeHtml(l.memberName)}</td><td>${escapeHtml(l.bookTitle)}</td><td>${toShamsiStr(l.dueISO)}</td></tr>`).join('')}</tbody></table></div>`;
            }
          });
        });

        document.getElementById('printReport').addEventListener('click', async () => {
          const header = `<div style="text-align:center;margin-bottom:8px;"><div style="font-weight:700;font-size:16px">${escapeHtml(document.getElementById('libName').textContent || '')}</div><div style="font-size:12px">${escapeHtml(nowShamsiFull())}</div></div>`;
          const contentRaw = main.innerHTML || '<div class="small">Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
          const content = cleanPrintableContent(contentRaw);

          // create pages (rowsPerPage tuned for your needs; reduce if table rows are tall)
          const rowsPerPage = 30;
          const pages = await createPrintablePages(header, content, rowsPerPage);
          // small delay to allow rendering
          await new Promise(r => setTimeout(r, 150));
          window.print();
          setTimeout(() => { printArea.innerHTML = ''; }, 800);
        });

        main.innerHTML = `<div class="small">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø³Ù…Øª Ú†Ù¾ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>`;
      }

      /* ========== Settings ========== */
      async function renderSettings() {
        const lib = await getSetting('LibraryName'); const loan = await getSetting('LoanDaysDefault'); const max = await getSetting('MaxBooksPerMember');
        const grades = await getSetting('Grades'); const fields = await getSetting('Fields'); const theme = await getSetting('Theme') || 'dark';
        const requireLogin = (await getSetting('RequireAdminLogin')) === '1';
        panelContent.innerHTML = `
        <div class="small">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ</div>
        <div style="margin-top:8px">
          <div class="form-row"><label>Ù†Ø§Ù… Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡</label><div class="field"><input id="s_lib" type="text" value="${escapeHtml(lib || '')}" /></div></div>
          <div class="form-row"><label>Ù…Ù‡Ù„Øª Ø§Ù…Ø§Ù†Øª (Ø±ÙˆØ²)</label><div class="field"><input id="s_loan" type="number" min="1" value="${escapeHtml(loan || '10')}" /></div></div>
          <div class="form-row"><label>Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ù…Ø§Ù†Øª</label><div class="field"><input id="s_max" type="number" min="1" value="${escapeHtml(max || '3')}" /></div></div>
          <div class="form-row"><label>Ù¾Ø§ÛŒÙ‡â€ŒÙ‡Ø§ (, Ø¬Ø¯Ø§ Ú©Ù†)</label><div class="field"><input id="s_grades" type="text" value="${escapeHtml(grades || '')}" /></div></div>
          <div class="form-row"><label>Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ (, Ø¬Ø¯Ø§ Ú©Ù†)</label><div class="field"><input id="s_fields" type="text" value="${escapeHtml(fields || '')}" /></div></div>
          <div class="form-row"><label>Ù„ÙˆÚ¯Ùˆ</label><div class="field"><input id="s_logo" type="file" accept="image/*" /></div></div>
          <div class="form-row"><label>Ø­Ø§Ù„Øª Ø±Ø§Ø¨Ø·</label><div class="field"><select id="s_theme" class="fancy"><option value="dark"${theme === 'dark' ? ' selected' : ''}>ØªØ§Ø±ÛŒÚ©</option><option value="light"${theme === 'light' ? ' selected' : ''}>Ø±ÙˆØ´Ù†</option></select></div></div>

          <!-- Admin password management -->
          <div class="form-row"><label>Ø±Ù…Ø² Ù…Ø¯ÛŒØ± (ØªØºÛŒÛŒØ±)</label><div class="field"><input id="s_pass" type="password" placeholder="Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" /></div></div>
          <div class="form-row"><label>Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯</label><div class="field"><select id="s_require_login" class="fancy"><option value="1"${requireLogin ? ' selected' : ''}>ÙØ¹Ø§Ù„</option><option value="0"${!requireLogin ? ' selected' : ''}>ØºÛŒØ±ÙØ¹Ø§Ù„</option></select></div></div>
          <div style="margin-left:110px;margin-top:6px"><div class="small muted">Ø±Ù…Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶: <strong>111</strong></div></div>

          <div class="form-row"><label></label><div class="controls"><button id="s_save" class="btn primary">Ø°Ø®ÛŒØ±Ù‡</button><button id="s_reset" class="btn">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button></div></div>
        </div>
      `;
        document.getElementById('s_logo').addEventListener('change', async (e) => {
          const f = e.target.files[0]; if (!f) return;
          try { const resized = await resizeImageFile(f, 200, 200, 0.9); await setSetting('LogoDataURL', resized); logoEl.innerHTML = `<img src="${resized}" alt="logo">`; alert('Ù„ÙˆÚ¯Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÙˆÚ¯Ùˆ: ' + err); }
        });
        document.getElementById('s_save').addEventListener('click', async () => {
          await setSetting('LibraryName', document.getElementById('s_lib').value.trim());
          await setSetting('LoanDaysDefault', String(Number(document.getElementById('s_loan').value || 10)));
          await setSetting('MaxBooksPerMember', String(Number(document.getElementById('s_max').value || 3)));
          await setSetting('Grades', document.getElementById('s_grades').value.trim());
          await setSetting('Fields', document.getElementById('s_fields').value.trim());
          const pass = document.getElementById('s_pass').value.trim();
          if (pass) await setSetting('AdminPasswordHash', await sha256(pass));
          const req = document.getElementById('s_require_login').value; await setSetting('RequireAdminLogin', req);
          const th = document.getElementById('s_theme').value; await applyTheme(th);
          libNameEl.textContent = document.getElementById('s_lib').value.trim() || 'Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø´Ù‡ÛŒØ¯ Ø´ÛŒØ± Ø¢Ù‚Ø§Ø¦ÛŒ';
          alert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        });
        document.getElementById('s_reset').addEventListener('click', async () => {
          if (!confirm('Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ØŸ')) return;
          await setSetting('Grades', 'Ø¯Ù‡Ù…,ÛŒØ§Ø²Ø¯Ù‡Ù…,Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…,Ù¾Ø§ÛŒÙ‡,ÛŒØ§Ø²Ø¯Ù‡Ù… - Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…,Ø¬Ø§Ù…Ø¹'); await setSetting('Fields', 'ØªØ¬Ø±Ø¨ÛŒ,Ø±ÛŒØ§Ø¶ÛŒ,Ø§Ù†Ø³Ø§Ù†ÛŒ,Ø¬Ø§Ù…Ø¹');
          alert('Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); renderSettings();
        });
        main.innerHTML = `<div class="small">Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</div>`;
      }

      /* ========== Card printing tools (group printing) ========== */
      async function renderCardTools() {
        panelContent.innerHTML = `
          <div class="small">Ú†Ø§Ù¾ Ú¯Ø±ÙˆÙ‡ÛŒ Ú©Ø§Ø±Øªâ€Œ Ø¹Ø¶ÙˆÛŒØª</div>
          <div style="margin-top:8px">
            <div class="form-row"><label>Ø¹Ø±Ø¶ Ú©Ø§Ø±Øª (mm)</label><div class="field"><input id="cardWidth" type="number" min="10" value="85" /></div></div>
            <div class="form-row"><label>Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ø±Øª (mm)</label><div class="field"><input id="cardHeight" type="number" min="10" value="60" /></div></div>
            <div class="form-row"><label>ÙØ¶Ø§ÛŒ Ø¨ÛŒÙ† Ú©Ø§Ø±ØªÛŒ (mm)</label><div class="field"><input id="cardMargin" type="number" min="0" value="3" /></div></div>
            <div class="form-row"><label>Ø­Ø§Ø´ÛŒÙ‡ ØµÙØ­Ù‡ (mm)</label><div class="field"><input id="pagePadding" type="number" min="0" value="4" /></div></div>
            <div style="margin-top:10px;display:flex;gap:8px"><button id="generateCards" class="btn primary">Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button><button id="printCardsBtn" class="btn">ğŸ–¨ Ú†Ø§Ù¾ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§</button></div>
          </div>
        `;
        const members = await getMembers();
        main.innerHTML = `<div class="small">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø¹Ø¶Ø§ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button id="selectAll" class="btn ghost">Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</button>
            <button id="clearAll" class="btn ghost">Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨</button>
            <button id="toggleSample" class="btn ghost">Ù†Ù…ÙˆÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ú©Ø³ Ø¨Ø±Ø§ÛŒ ØªØ³Øª</button>
          </div>
          <div id="membersSelectArea" style="margin-top:10px;max-height:420px;overflow:auto;border-radius:8px;padding:8px;background:var(--card-bg)"></div>
          <div id="cardsPreview" style="margin-top:12px"></div>
        `;
        const area = document.getElementById('membersSelectArea');
        area.innerHTML = '';
        (members || []).forEach(m => {
          const el = document.createElement('label'); el.style.display = 'block'; el.style.padding = '8px'; el.style.borderRadius = '8px';
          el.innerHTML = `<input type="checkbox" class="member-ck" value="${m.id}" data-id="${m.id}" /> <strong>${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)}</strong> â€” <span class="muted">${escapeHtml(m.membershipCode)}</span>`;
          area.appendChild(el);
        });
        document.getElementById('selectAll').addEventListener('click', () => { document.querySelectorAll('#membersSelectArea input.member-ck').forEach(i => i.checked = true); });
        document.getElementById('clearAll').addEventListener('click', () => { document.querySelectorAll('#membersSelectArea input.member-ck').forEach(i => i.checked = false); });
        document.getElementById('toggleSample').addEventListener('click', async () => {
          const ms = await getMembers();
          for (const m of ms) {
            if (!m.photo) {
              m.photo = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180"><rect width="100%" height="100%" fill="#f4f4f4"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#444">Ù…Ø­Ù„ Ø§Ù„ØµØ§Ù‚ Ø¹Ú©Ø³</text></svg>`)}`;
              await idbPut('members', m);
            }
          }
          showToast('Ù†Ù…ÙˆÙ†Ù‡ Ø¹Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø¶Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
        });

        document.getElementById('generateCards').addEventListener('click', async () => {
          const checked = Array.from(document.querySelectorAll('#membersSelectArea input.member-ck:checked')).map(n => Number(n.value));
          if (checked.length === 0) { alert('Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø¶Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
          const membersAll = await getMembers();
          const sel = membersAll.filter(m => checked.includes(m.id));
          const cw = Number(document.getElementById('cardWidth').value || 85);
          const ch = Number(document.getElementById('cardHeight').value || 60);
          const cm = Number(document.getElementById('cardMargin').value || 3);
          const pp = Number(document.getElementById('pagePadding').value || 4);
          generateCardPagesPreview(sel, cw, ch, cm, pp);
        });

        document.getElementById('printCardsBtn').addEventListener('click', async () => {
          const checked = Array.from(document.querySelectorAll('#membersSelectArea input.member-ck:checked')).map(n => Number(n.value));
          if (checked.length === 0) { alert('Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø¶Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
          const membersAll = await getMembers();
          const sel = membersAll.filter(m => checked.includes(m.id));
          const cw = Number(document.getElementById('cardWidth').value || 85);
          const ch = Number(document.getElementById('cardHeight').value || 60);
          const cm = Number(document.getElementById('cardMargin').value || 3);
          const pp = Number(document.getElementById('pagePadding').value || 4);
          buildPrintPagesForCards(sel, cw, ch, cm, pp);
          await new Promise(r => setTimeout(r, 250));
          window.print();
          setTimeout(() => { document.getElementById('printArea').innerHTML = ''; }, 800);
        });
      }

      /* ========== Cards HTML builder & helpers ========== */
      function buildCardHTML(member) {
        const lib = escapeHtml(document.getElementById('libName').textContent || '');
        const name = escapeHtml(member.firstName || '');
        const lastname = escapeHtml(member.lastName || '');
        const code = escapeHtml(member.membershipCode || '');
        const photo = member.photo || '';
        return `<div class="print-card double-border" role="document" lang="fa" style="box-sizing:border-box">
          <div class="lib">${lib}</div> </br>
          <div class="flex-box" style="display:flex;align-items:center;margin-top:6px">
            <div class="left" style="width:100%;direction:rtl;align-items:flex-start;">
              <div class="code" style="font-weight:700">Ú©Ø¯ Ø¹Ø¶ÙˆÛŒØª: ${code}</div>
              <div class="name" style="margin-top:6px">Ù†Ø§Ù… : ${name}</div>
              <div class="name">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ : ${lastname}</div>
              <div class="phone" style="margin-top:6px">Ù¾Ø§ÛŒÙ‡: ${escapeHtml(member.grade || '')}</div>
              <div class="phone">Ø±Ø´ØªÙ‡: ${escapeHtml(member.field || '')}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:center;margin-left:10px;">
              ${photo ? `<img class="photo" src="${photo}"  style="width:90px;height:90px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,255,255,0.12)"/>` : `<div class="photo" style="width:90px;height:90px;border-radius:8px;background:#fff"></div>`}
            </div>
          </div>
        </div>`;
      }

      async function printMemberCard(member) {
        // wrap in a print-page so CSS page rules apply
        const html = `<div class="print-page" style="width:210mm;box-sizing:border-box;padding:10mm;background:var(--print-bg)"><div style="display:flex;align-items:center;justify-content:center;height:100%">${buildCardHTML(member)}</div></div>`;
        printArea.innerHTML = html;
        await new Promise(r => setTimeout(r, 200));
        window.print();
        setTimeout(() => { printArea.innerHTML = ''; }, 600);
      }

      function generateCardPagesPreview(members, cardWmm, cardHmm, marginMm, pagePaddingMm) {
        const preview = document.getElementById('cardsPreview');
        preview.innerHTML = '';
        const pageW = 210, pageH = 297; // mm
        const usableW = pageW - pagePaddingMm * 2;
        const usableH = pageH - pagePaddingMm * 2;
        const totalCardW = cardWmm + marginMm * 2;
        const totalCardH = cardHmm + marginMm * 2;
        const cols = Math.max(1, Math.floor(usableW / totalCardW));
        const rows = Math.max(1, Math.floor(usableH / totalCardH));
        const perPage = cols * rows;
        const info = document.createElement('div'); info.className = 'small muted'; info.style.marginBottom = '6px';
        info.textContent = `Ú†ÛŒØ¯Ù…Ø§Ù†: ${cols} Ø³ØªÙˆÙ† Ã— ${rows} Ø±Ø¯ÛŒÙ â€” Ù‡Ø± ØµÙØ­Ù‡: ${perPage} Ú©Ø§Ø±Øª â€” ØµÙØ­Ø§Øª: ${Math.ceil(members.length / perPage)}`;
        preview.appendChild(info);

        for (let i = 0; i < members.length; i += perPage) {
          const pageMembers = members.slice(i, i + perPage);
          const page = document.createElement('div'); page.className = 'group-page';
          page.style.padding = pagePaddingMm + 'mm';
          page.style.width = pageW + 'mm';
          page.style.height = pageH + 'mm';
          page.style.boxSizing = 'border-box';
          pageMembers.forEach(m => {
            const wrap = document.createElement('div'); wrap.className = 'card-wrapper';
            wrap.style.width = cardWmm + 'mm'; wrap.style.height = cardHmm + 'mm'; wrap.style.margin = marginMm + 'mm';
            wrap.style.boxSizing = 'border-box';
            wrap.style.flex = '0 0 auto';
            wrap.innerHTML = buildCardHTML(m);
            page.appendChild(wrap);
          });
          preview.appendChild(page);
        }
      }

      function buildPrintPagesForCards(members, cardWmm, cardHmm, marginMm, pagePaddingMm) {
        const printAreaEl = document.getElementById('printArea');
        printAreaEl.innerHTML = '';
        const pageW = 210, pageH = 297; // mm
        const usableW = pageW - pagePaddingMm * 2;
        const usableH = pageH - pagePaddingMm * 2;
        const totalCardW = cardWmm + marginMm * 2;
        const totalCardH = cardHmm + marginMm * 2;
        const cols = Math.max(1, Math.floor(usableW / totalCardW));
        const rows = Math.max(1, Math.floor(usableH / totalCardH));
        const perPage = cols * rows;

        for (let i = 0; i < members.length; i += perPage) {
          const pageMembers = members.slice(i, i + perPage);
          const page = document.createElement('div');
          page.style.width = pageW + 'mm';
          page.style.height = pageH + 'mm';
          page.style.boxSizing = 'border-box';
          page.style.padding = pagePaddingMm + 'mm';
          page.style.display = 'flex';
          page.style.flexWrap = 'wrap';
          page.style.alignContent = 'flex-start';
          page.style.background = 'white';
          const hasMore = (i + perPage) < members.length;
          page.style.pageBreakAfter = hasMore ? 'always' : 'auto';
          page.style.breakAfter = hasMore ? 'page' : 'auto';
          page.className = 'group-page';

          pageMembers.forEach(m => {
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';
            wrapper.style.width = cardWmm + 'mm';
            wrapper.style.height = cardHmm + 'mm';
            wrapper.style.margin = marginMm + 'mm';
            wrapper.style.boxSizing = 'border-box';
            wrapper.style.flex = '0 0 auto';
            wrapper.innerHTML = buildCardHTML(m);
            page.appendChild(wrapper);
          });

          printAreaEl.appendChild(page);
        }
      }

      /* ========== backup/restore/export ========= */
      document.getElementById('backupBtn').addEventListener('click', async () => {
        const members = await getMembers(); const books = await getBooks(); const loans = await getLoans();
        const settings = {}; (await idbAll('settings')).forEach(s => settings[s.key] = s.value);
        const obj = { meta: { exportedAt: (new Date()).toISOString() }, settings, members, books, loans };
        downloadFile(JSON.stringify(obj, null, 2), 'library_backup.json', 'application/json');
      });
      document.getElementById('restoreBtn').addEventListener('click', () => document.getElementById('fileRestore').click());
      document.getElementById('fileRestore').addEventListener('change', async (e) => {
        const f = e.target.files[0]; if (!f) return; if (!confirm('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø¨Ø§Ø¹Ø« Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØŸ')) return;
        const txt = await f.text();
        try {
          const obj = JSON.parse(txt);
          await idbClear('members'); await idbClear('books'); await idbClear('loans');
          if (obj.settings) for (const k of Object.keys(obj.settings)) await setSetting(k, obj.settings[k]);
          if (obj.members) for (const m of obj.members) { try { await idbAdd('members', m); } catch (e) { } }
          if (obj.books) for (const b of obj.books) { try { await idbAdd('books', b); } catch (e) { } }
          if (obj.loans) for (const l of obj.loans) { try { await idbAdd('loans', l); } catch (e) { } }
          alert('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); showTab('dashboard');
        } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ: ' + err); }
      });
      document.getElementById('exportJSON').addEventListener('click', async () => {
        const members = await getMembers(), books = await getBooks();
        const o = { members, books, exportedAt: (new Date()).toISOString() };
        downloadFile(JSON.stringify(o, null, 2), 'export.json', 'application/json');
      });

      /* SHA-256 - Web Crypto */
      async function sha256(message) { const enc = new TextEncoder(); const data = enc.encode(message); const hash = await crypto.subtle.digest('SHA-256', data); return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join(''); }

      // expose minimal debugging helpers
      window.libApp = { getMembers, getBooks, getLoans, buildCardHTML };

      /* ========== Factory reset (Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª) ========== */
      factoryResetBtn.addEventListener('click', async () => {
        if (!confirm('Ù‡Ø´Ø¯Ø§Ø±: Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ù‡â€ŒØ·ÙˆØ± Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØŸ')) return;
        const verify = prompt('Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ú©Ù„Ù…Ù‡Ù” "RESET" Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
        if (verify !== 'RESET') {
          alert('Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù„ØºÙˆ Ø´Ø¯ â€” ØªØ£ÛŒÛŒØ¯ Ù„Ø§Ø²Ù… Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.');
          return;
        }
        try {
          try { if (db && db.close) db.close(); } catch (e) { /* ignore */ }
          await new Promise((resolve, reject) => {
            const req = indexedDB.deleteDatabase(DB_NAME);
            req.onsuccess = () => resolve();
            req.onerror = (ev) => reject(ev.target && ev.target.error ? ev.target.error : new Error('delete error'));
            req.onblocked = () => {
              console.warn('deleteDatabase blocked: Ø¯ÛŒÚ¯Ø± ØªØ¨â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª IndexedDB Ø±Ø§ Ø¨Ø§Ø² Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯.');
            };
          });
          showToast('Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ â€” ØµÙØ­Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø§Ø³Øª...');
          setTimeout(() => location.reload(), 800);
        } catch (err) {
          console.error('Factory reset failed', err);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ' + (err && err.message ? err.message : String(err)));
        }
      });

    })();
  </script>
</body>

</html>
